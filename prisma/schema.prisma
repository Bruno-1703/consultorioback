datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

type CitaEnfermedad {
  id_enfermedad String   @map("_id") @db.ObjectId
  nombre_enf    String?
  fecha         DateTime @default(now()) @db.Date
}

type CitaEstudio {
  id_estudio        String   @map("_id") @db.ObjectId
  fecha_realizacion DateTime?
  codigo_referencia String?
  observaciones      String?
  resultado          String?
  tipo_estudio       String?
  medico_solicitante String?
}

type PacienteCita {
  id_paciente String?
  dni             String?
  nombre_paciente String?
  apellido_paciente String?
}
type CitaDoctor {
  id_Usuario     String ?
  nombre_usuario String?
  email          String?
  especialidad     String?
  matricula        String ?  
  telefono         String?
  nombre_completo String?
  dni              String?
}

type CitaMedicamento {
  id_medicamento String
  nombre_med     String?
}
//****************************************************************************************************
model CentroSalud {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  nombre      String
  tipo        String   // "CIC" o "CONSULTORIO"
  direccion   String?

  // Relaciones
  usuarios    UsuarioCentro[]
  citas       Cita[]
  pacientes   Paciente[]  
  medicamentos Medicamento[]
}
// Esta es la tabla clave: vincula a Gisela con distintos centros y distintos roles
model UsuarioCentro {
  id             String      @id @default(auto()) @map("_id") @db.ObjectId
  usuarioId      String      @db.ObjectId
  centroSaludId  String      @db.ObjectId
  rol            String      // "ADMIN", "DOCTOR", "SECRETARIA"
  
  usuario        Usuario     @relation(fields: [usuarioId], references: [id_Usuario])
  centroSalud    CentroSalud @relation(fields: [centroSaludId], references: [id])

  @@unique([usuarioId, centroSaludId]) // Evita que un usuario se duplique en el mismo centro
}

// ---------------------------- MODELOS EXISTENTES MODIFICADOS ------------------------------------

model Cita {
  id_cita           String   @id @default(auto()) @map("_id") @db.ObjectId  
  motivoConsulta    String?
  observaciones     String?
  diagnostico       String?
  cancelada         Boolean  @default(false)

  fechaProgramada   DateTime
  fechaCreacion     DateTime @default(now())
  fechaModificacion DateTime? @updatedAt

  paciente          PacienteCita
  doctor            CitaDoctor

  enfermedades      CitaEnfermedad[]
  medicamentos      CitaMedicamento[]
  estudios          CitaEstudio[]

  finalizada        Boolean @default(false)
  registradoPorId   String?

  centroSaludId     String @db.ObjectId
  centroSalud       CentroSalud @relation(fields: [centroSaludId], references: [id])
}

model Estudio {
  id_estudio         String   @id @default(auto()) @map("_id") @db.ObjectId
  fecha_realizacion  DateTime
  tipo_estudio       String
  resultado          String?
  codigo_referencia  String
  observaciones      String?
  medico_solicitante String?
  urgente            Boolean?
}

model Medicamento {
  id_medicamento         String    @id @default(auto()) @map("_id") @db.ObjectId
  nombre_med             String?
  marca                  String?
  fecha_vencimiento      DateTime?
  dosis_hs               String?
  agente_principal       String?
  efectos_secundarios    String?
  lista_negra            Boolean?
  categoria              String?
  contraindicaciones     String?
  prescripcion_requerida Boolean?
  eliminadoLog           Boolean  @default(false)
  stock                  Int       @default(0) 
  centroSaludId String      @db.ObjectId
  centroSalud   CentroSalud @relation(fields: [centroSaludId], references: [id])
}

model Enfermedad {
  id_enfermedad String  @id @default(auto()) @map("_id") @db.ObjectId
  nombre_enf    String
  sintomas      String
  gravedad      String?
  eliminadoLog       Boolean @default(false)

}

model Paciente {
  id_paciente       String         @id @default(auto()) @map("_id") @db.ObjectId
  dni               String?
  nombre_paciente   String?
  apellido_paciente String?
  edad              Int?
  altura            Int?
  telefono          String?
  fecha_nacimiento  DateTime?
  sexo              String?
  grupo_sanguineo   String?
  alergias          String?
  obra_social       String?    // Nuevo
  email             String?    // Nuevo
  direccion         String?    // Nuevo
  nacionalidad      String?    // Nuevo
  eliminadoLog      Boolean  @default(false)

  centroSaludId     String   @db.ObjectId
  centroSalud       CentroSalud @relation(fields: [centroSaludId], references: [id])
}
model Usuario {
  id_Usuario     String  @id @default(auto()) @map("_id") @db.ObjectId
  nombre_usuario String
  email          String  @unique
  password       String
  deletLogico    Boolean @default(false)
  rol_usuario    String
  nombre_completo  String
  especialidad     String
  matricula        String   @unique
  dni              String   @unique
  telefono         String?
  resetToken        String?
  resetTokenExpiry  DateTime?
  centros           UsuarioCentro[]
}


enum Accion {
  CREATE
  UPDATE
  DELETE
  READ
  ARCHIVE
}

model Auditoria {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  accion       Accion
  usuarioId    String?
  usuarioNom   String?
  detalles     String?
  model        String
  registro_id  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([usuarioId])
  @@index([model])
  @@index([registro_id])
}


